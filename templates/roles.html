{% extends "base.html" %}

{% block title %}Assign Roles & Permissions{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumb">
    <a href="/dashboard"><i class="fas fa-home"></i> Admin</a>
    <i class="fas fa-angle-right"></i>
    <a href="/roles"><span>Assign Roles</span></a>
    <h1>Assign Roles & Permissions</h1>
</div>
{% endblock %}

{% block content %}

<style>
/* Left user list */
.user-item {
    font-size: 16px;
    padding: 10px 14px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}
.user-item:hover { background: #5ca8fa; }
.user-item.active {
    background: #0056b3;
    border-left: 3px solid #2a70d6;
    font-weight: 600;
}

/* Table */
.table thead th {
    background: #2a70d6;
    color: white;
    text-align: center;
    font-size: 14px;
}
.table td {
    text-align: center;
    padding: 8px;
    font-size: 14px;
}
.page-name {
    text-align: left !important;
    font-weight: 500;
}

/* Button Row */
.button-row {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 15px;
}

.small-btn {
    padding: 8px 14px;
    font-size: 14px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
}

.btn-select-all {
    background: #28a745;
    color: white;
}
.btn-select-none {
    background: #dc3545;
    color: white;
}
.btn-save {
    background: #2a70d6;
    color: white;
}

.small-btn:hover {
    opacity: 0.85;
}
</style>

<div class="row">
    <!-- USER LIST -->
    <div class="col-md-4">
        <h5 class="section-heading">Users</h5>
        <ul class="list-group" id="user-list">
            {% for user in users %}
            <li class="list-group-item user-item" data-username="{{ user }}">
                {{ user }}
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- PERMISSIONS SECTION -->
    <div class="col-md-1"></div>

    <div class="col-md-7">

        <h5 id="role-header" class="section-heading text-muted">
            Select a user to assign roles & permissions
        </h5>

        <input type="hidden" id="selected-username">

      

        <!-- TABLE -->
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Page</th>
                    <th>Visible</th>
                    <!-- <th>View</th> -->
                    <th>Add</th>
                    <th>Edit</th>
                    <th>Delete</th>
                </tr>
            </thead>

            <tbody id="permission-body">
                {% for page in ["dashboard","production","raw_material","recipe","report","tag"] %}
                <tr class="permission-row">
                    <td class="page-name">{{ page.replace("_", " ")|title }}</td>

                    <td><input type="checkbox" class="visible-checkbox" data-page="{{ page }}"></td>
                    <!-- <td><input type="checkbox" data-page="{{ page }}" data-action="view"></td> -->
                    <td><input type="checkbox" data-page="{{ page }}" data-action="add"></td>
                    <td><input type="checkbox" data-page="{{ page }}" data-action="edit"></td>
                    <td><input type="checkbox" data-page="{{ page }}" data-action="delete"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="button-row">
    <button class="small-btn btn-select-all" onclick="selectAll(true)">Select All</button>
    <button class="small-btn btn-select-none" onclick="selectAll(false)">Select None</button>
    <button class="small-btn btn-save" id="save-access">Save Access</button>
</div>

    </div>
</div>

<script>
let selectedUser = null;

// ----------------- SELECT ALL / NONE -------------------
function selectAll(flag) {
    document.querySelectorAll("#permission-body input[type='checkbox']")
        .forEach(chk => chk.checked = flag);
}

// ----------------- SELECT USER -------------------------
document.querySelectorAll('.user-item').forEach(item => {
    item.addEventListener('click', () => {

        document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
        item.classList.add('active');

        selectedUser = item.dataset.username;
        document.getElementById('role-header').innerHTML =
            `Assign Access for <strong>${selectedUser}</strong>`;

        // Load visible pages
        fetch('/get_roles', {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ username: selectedUser })
        })
        .then(r => r.json())
        .then(data => {
            let visible = data.roles || [];

            document.querySelectorAll('.visible-checkbox').forEach(chk => chk.checked = false);

            visible.forEach(page => {
                const chk = document.querySelector(`.visible-checkbox[data-page="${page}"]`);
                if (chk) chk.checked = true;
            });
        });

        // Load view/add/edit/delete
        fetch('/get_user_access', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: selectedUser })
        })
        .then(res => res.json())
        .then(data => {
            let permissions = data.permissions;

            document.querySelectorAll('#permission-body input[data-action]')
                .forEach(chk => chk.checked = false);

            for (let page in permissions) {
                for (let action in permissions[page]) {
                    if (permissions[page][action] == 1) {
                        let selector = `input[data-page="${page}"][data-action="${action}"]`;
                        document.querySelector(selector).checked = true;
                    }
                }
            }
        });
    });
});

// ----------------- SAVE ACCESS -------------------------
document.getElementById("save-access").addEventListener("click", () => {

    if (!selectedUser) {
        alert("Please select a user first!");
        return;
    }

    let permissionData = {};

    document.querySelectorAll('#permission-body input[data-action]')
        .forEach(chk => {
            let page = chk.dataset.page;
            let action = chk.dataset.action;

            if (!permissionData[page]) {
                permissionData[page] = { view: 0, add: 0, edit: 0, delete: 0 };
            }

            permissionData[page][action] = chk.checked ? 1 : 0;
        });

    let visiblePages = [];
    document.querySelectorAll('.visible-checkbox').forEach(chk => {
        if (chk.checked) visiblePages.push(chk.dataset.page);
    });

    fetch("/save_user_access", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            username: selectedUser,
            permissions: permissionData,
            visible_pages: visiblePages
        })
    })
    .then(res => res.json())
    .then(() => alert("Access saved successfully!"));
});
</script>

{% endblock %}
