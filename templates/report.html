{% extends "base.html" %}
{% block title %}Recipe Report{% endblock %}
{% block breadcrumbs %}
<div class="breadcrumb">
        <a href="/dashboard"><i class="fas fa-home"></i> Dashboard</a>
        <i class="fas fa-angle-right"></i>
        <a href="/production"><span>Report</span></a>        
        <h1> Report Table</h1>
</div>
{% endblock %}
{% block content %}

<div class="report-filters">
    <div class="filter-container">
        <form method="POST" action="/report" id="filter-form">
            <div class="date-filter">
                <label for="report-start-date">From:</label>
                <input type="text" id="report-start-date" name="start_date" placeholder="Select start date"
                    value="{{ start_date if start_date else '' }}">
            </div>
            <div class="date-filter">
                <label for="report-end-date">To:</label>
                <input type="text" id="report-end-date" name="end_date" placeholder="Select end date"
                    value="{{ end_date if end_date else '' }}">
            </div>
            <button type="submit" class="filter-btn">Filter</button>
            <button type="button" class="refresh-btn" id="reset-filters">Refresh</button>
        </form>
            <!-- PDF Download Button -->
        <form method="POST" action="/download" id="download-form">
            <input type="hidden" name="filtered_data" id="filtered-data">
            <button type="submit" name="format" value="pdf" class="download-btn">Download as PDF</button>
        </form>  
    </div>  
</div>

<table class="table table-bordered table-striped" id="report-table">
  <thead class="thead-dark">
    <tr>
      <th>Batch Code</th>
      <th>Timestamp</th>
      <th>Recipe Name</th>
      <th>Article No</th>
      <th>Filter Size</th>
      <th>FilterSize</th>
      <th>Ng Status</th>
      <th>Serial No</th>
      <th>Parameter 1</th>
      <th>Parameter 2</th>
      <th>Batch Completion Status</th>
    </tr>
    <!-- ✅ Filter row added below header -->
    <tr class="column-filters">
      <th><input type="text" class="column-search" data-col="0" placeholder="Search Batch Code"></th>
      <th><input type="text" class="column-search" data-col="1" placeholder="Search Timestamp"></th>
      <th><input type="text" class="column-search" data-col="2" placeholder="Search Recipe Name"></th>
      <th><input type="text" class="column-search" data-col="3" placeholder="Search Article No"></th>
      <th><input type="text" class="column-search" data-col="4" placeholder="Search Filter Size"></th>
      <th><input type="text" class="column-search" data-col="5" placeholder="Search FilterSize"></th>
      <th><input type="text" class="column-search" data-col="6" placeholder="Search Ng Status"></th>
      <th><input type="text" class="column-search" data-col="7" placeholder="Search Serial No"></th>
      <th><input type="text" class="column-search" data-col="8" placeholder="Search Parameter 1"></th>
      <th><input type="text" class="column-search" data-col="9" placeholder="Search Parameter 2"></th>
      <th><input type="text" class="column-search" data-col="10" placeholder="Search Batch Status"></th>
    </tr>
  </thead>
  <tbody>
    {% for row in data %}
    <tr>
      <td>{{ row.Batch_Code }}</td>
      <td>{{ row.Timestamp }}</td>
      <td>{{ row.Recipe_Name }}</td>
      <td>{{ row.Article_No }}</td>
      <td>{{ row.Filter_Size }}</td>
      <td>{{ row.FilterSize }}</td>
      <td>{{ row.NgStatus }}</td>
      <td>{{ row.SerialNo }}</td>
      <td>{{ row.Parameter1 }}</td>
      <td>{{ row.Parameter2 }}</td>
      <td>{{ row.Batch_Completion_Status }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Showing Entries Info -->
<div class="entries-info">
    Showing <span id="entry-start">0</span> to <span id="entry-end">0</span> of <span id="entry-total">0</span> entries
</div>
<div class="pagination-container"></div>
<div class="d-flex justify-content-between align-items-center mt-3">
  <div>
    <small>
      Showing {{ start_entry }} – {{ end_entry }} of {{ total_count }} entries
    </small>
  </div>

  <nav>
    <ul class="pagination mb-0">
      <li class="page-item {% if page == 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('report', page=page-1) }}">Previous</a>
      </li>

      {% for i in range(1, total_pages + 1) %}
        <li class="page-item {% if page == i %}active{% endif %}">
          <a class="page-link" href="{{ url_for('report', page=i) }}">{{ i }}</a>
        </li>
      {% endfor %}

      <li class="page-item {% if page == total_pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('report', page=page+1) }}">Next</a>
      </li>
    </ul>
  </nav>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // ✅ --- DATE FILTER FORM ---
  const filterForm = document.getElementById("filter-form");
  const resetBtn = document.getElementById("reset-filters");
  const startInput = document.getElementById("report-start-date");
  const endInput = document.getElementById("report-end-date");

  filterForm.addEventListener("submit", function (e) {
    const startDate = startInput.value;
    const endDate = endInput.value;
    if (!startDate || !endDate) {
      alert("❌ Please select both start and end dates.");
      e.preventDefault();
    }
  });

  resetBtn.addEventListener("click", function () {
    startInput.value = "";
    endInput.value = "";
    filterForm.submit();
  });

  flatpickr("#report-start-date", { dateFormat: "Y-m-d", allowInput: true });
  flatpickr("#report-end-date", { dateFormat: "Y-m-d", allowInput: true });

  // ✅ --- COLUMN-WISE FILTERING ---
  const table = document.getElementById("report-table");
  const rows = Array.from(table.querySelectorAll("tbody tr"));
  const columnInputs = document.querySelectorAll(".column-search");

  columnInputs.forEach(input => {
    input.addEventListener("input", () => applyColumnFilters());
  });

  function applyColumnFilters() {
    const filters = Array.from(columnInputs).map(inp => inp.value.toLowerCase().trim());
    rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      let visible = true;
      filters.forEach((filter, i) => {
        if (filter && !cells[i].textContent.toLowerCase().includes(filter)) {
          visible = false;
        }
      });
      row.style.display = visible ? "" : "none";
    });
    updatePagination(1); // Refresh pagination after filtering
  }

  // ✅ --- PDF DOWNLOAD (only visible rows) ---
  document.getElementById("download-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const visibleRows = Array.from(rows).filter(r => r.style.display !== "none");
    const data = visibleRows.map(r => Array.from(r.querySelectorAll("td")).map(td => td.textContent.trim()));
    document.getElementById("filtered-data").value = JSON.stringify(data);
    this.submit();
  });

  // ✅ --- PAGINATION ---
  const rowsPerPage = 10;
  const paginationContainer = document.querySelector(".pagination-container");
  const entriesInfo = document.querySelector(".entries-info");
  let currentPage = 1;

  function renderTable(page) {
    const visibleRows = rows.filter(r => r.style.display !== "none");
    const totalPages = Math.ceil(visibleRows.length / rowsPerPage);
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    visibleRows.forEach((row, index) => {
      row.style.display = index >= start && index < end ? "" : "none";
    });

    updatePaginationButtons(page, totalPages);
    updateEntriesInfo(page, visibleRows.length);
  }

  function updatePaginationButtons(activePage, totalPages) {
    paginationContainer.innerHTML = "";
    if (totalPages <= 1) return;

    const createBtn = (page, text, active = false) => {
      const btn = document.createElement("a");
      btn.href = "javascript:void(0)";
      btn.textContent = text;
      btn.className = `pagination-btn ${active ? "active" : ""}`;
      btn.onclick = () => changePage(page);
      return btn;
    };

    if (activePage > 1) paginationContainer.appendChild(createBtn(activePage - 1, "Previous"));
    for (let i = 1; i <= totalPages; i++) {
      paginationContainer.appendChild(createBtn(i, i, i === activePage));
    }
    if (activePage < totalPages) paginationContainer.appendChild(createBtn(activePage + 1, "Next"));
  }

  function updateEntriesInfo(page, totalVisible) {
    const start = (page - 1) * rowsPerPage + 1;
    const end = Math.min(page * rowsPerPage, totalVisible);
    entriesInfo.innerHTML = `Showing ${start} to ${end} of ${totalVisible} entries`;
  }

  window.changePage = function (page) {
    currentPage = page;
    renderTable(currentPage);
  };

  function updatePagination(page) {
    renderTable(page);
  }

  // ✅ Initial render
  renderTable(currentPage);
});
</script>



<style>
    .column-filters input {
  width: 100%;
  padding: 3px;
  font-size: 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
.column-filters input:focus {
  outline: none;
  border-color: #007bff;
}

    .report-filters {
        display: flex;
    align-items: center;
    gap: 15px; /* Adds space between elements */
    justify-content: center; /* Centers content */
    background: #f8f9fa;
    border: 2px solid #007bff;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    }
    
    .filter-container {
        display: flex;
        flex-wrap: nowrap;
        align-items: center;
        justify-content: center;
        gap: 15px;
         /* Ensures responsiveness */
    }
    
    .date-filter {
        display: flex;
        flex-direction: column;
    }
    
    .date-filter label {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .date-filter input {
        width: 180px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    
    .filter-btn,
    .download-btn {
        padding: 10px 15px;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: 0.3s;
    }
    .report-filters form {
        display: flex;
        align-items: center;
        gap: 15px; /* Adds spacing between elements */
        justify-content: center;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        flex-wrap: wrap; /* Ensures responsiveness */
    }
    .filter-btn {
        padding: 10px 15px;
        font-weight: bold;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    
    .filter-btn:hover {
        background-color: #0056b3;
    }
    
    .download-btn {
        background-color: #28a745;
        color: white;
    }
    
    .download-btn:hover {
        background-color: #218838;
    }
    
    
    .report-filters .date-filter {
        margin-bottom: 10px; /* Space between date filters */
    }
    .report-filters label {
        display: block; /* Make labels appear above inputs */
        margin-bottom: 5px; /* Space between label and input */
    }
    .report-filters input[type="text"] {
        padding: 8px;
        width: 200px; /* Fixed width for inputs */
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .report-filters button {
        padding: 8px 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }
    .report-filters button:hover {
        background-color: #0056b3;
    }
    .report-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    .report-table, .report-table th, .report-table td {
        border: 1px solid #ddd;
    }
    .report-table th, .report-table td {
        padding: 8px;
        text-align: left;
    }
    .report-table th {
        background-color: #f2f2f2;
    }
    .report-download-buttons {
        margin-bottom: 20px; /* Move download buttons above the table */
    }
    .report-download-buttons button {
        padding: 8px 16px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: 50%;
        margin-right: 10px;
    }
    .report-download-buttons button:hover {
        background-color: #218838;
    }
    .details-table {
        border-collapse: collapse;
        width: 100%;
        text-align: center; /* Centers text horizontally */
    }
    .table {
        table-layout: fixed;
    }
    
    .details-table th, .details-table td {
        padding: 4px; /* Reduces spacing */
        white-space: nowrap; /* Prevents text from wrapping */
        text-align: center; /* Centers text horizontally */
        vertical-align: middle; /* Centers text vertically */
        border: 1px solid black; /* Adds border for clarity */
    }
    .table-options-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .btn-toggle {
        background: #007bff;
        color: white;
        border: none;
        padding: 5px 7px;
        font-size: 18px;
        border-radius: 20%;
        cursor: pointer;
        transition: 0.3s;
        margin-right: 10px;
    }

    .btn-toggle:hover {
        background: #5093da;
    }

    .options-menu {
        display: none;
        flex-direction: row;
        align-items: center;
        gap: 10px;
        background: #aed6ed;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
        z-index: 10;
    }

    .options-menu .form-control {
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
    }

    .btn-filter, .btn-refresh {
        padding: 8px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        transition: 0.3s;
    }

    .btn-filter {
        background: #007bff;
        color: white;
    }

    .btn-filter:hover {
        background: #0056b3;
    }

    .btn-refresh {
        background: #dc3545;
        color: white;
    }

    .btn-refresh:hover {
        background: #c82333;
    }

    .dropdown-multi-select {
        position: relative;
        display: inline-block;
      }
      
      .dropdown-btn1 {
        padding: 6px 12px;
        border-radius: 5px;
        background: #fff;
        border: 1px solid #007bff;
        color: #007bff;
        cursor: pointer;
      }
      
      .dropdown-content1 {
        display: none;
        position: absolute;
        background-color: white;
        min-width: 250px;
        border: 1px solid #ddd;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        padding: 10px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 10;
      }
      
      .dropdown-multi-select:hover .dropdown-content1 {
        display: block;
      }
      
      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
        padding-left: 4px;
        justify-content: flex-start;
      }
      
      .tag {
        background: #007bff;
        color: white;
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 14px;
        display: flex;
        align-items: center;
      }
      
      .tag .remove-tag {
        margin-left: 8px;
        cursor: pointer;
        font-weight: bold;
      }
      
      
    .multi-select-dropdown {
        position: relative;
        width: 250px;
      }
      
      .dropdown-header {
        background-color: #fff;
        border: 2px solid #007bff;
        padding: 10px;
        cursor: pointer;
        border-radius: 6px;
        font-weight: 500;
        color: #007bff;
      }
      
      .dropdown-options {
        display: none;
        position: absolute;
        z-index: 1000;
        background-color: white;
        border: 2px solid #007bff;
        padding: 10px;
        border-radius: 0 0 6px 6px;
        max-height: 200px;
        overflow-y: auto;
        width: 100%;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
      }
      
      .dropdown-options label {
        display: block;
        padding: 5px 0;
        font-size: 14px;
        cursor: pointer;
      }
      
    .entries-info {
        text-align: center;
        font-weight: bold;
        color: #555;
        margin-bottom: 10px;
        border-bottom: 2px solid #ddd;
        padding-bottom: 5px;
    }

    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .pagination-btn {
        padding: 6px 10px;
        background-color: white; /* Default: white */
        color: #007bff; /* Blue text */
        text-decoration: none;
        border: 1px solid white; /* Blue border */
        border-radius: 5px;
        margin: 0 2px;
    }

    .pagination-btn:hover {
        background-color: #007bff;
        color: white;
    }

    .pagination-btn.active {
        background-color: #007bff; /* Blue background for active page */
        color: white;
        font-weight: bold;
        pointer-events: none; /* Prevent clicking on current page */
    }

    .pagination-btn.disabled {
        background-color: transparent;
        color: #ccc;
        border: none;
        pointer-events: none;
    }
</style>
{% endblock %}