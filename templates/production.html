{% extends "base.html" %} {% block title %}Filter Log{% endblock %} {% block
breadcrumbs %}
<div class="breadcrumb">
  <a href="/dashboard"><i class="fas fa-home"></i> Dashboard</a>
  <i class="fas fa-angle-right"></i>
  <a href="/production"><span>Production</span></a>
  <h1>Production Log</h1>
</div>
{% endblock %} {% block content %}
<style>
  .filter-export-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
    gap: 10px;
    background-color: #f8f9fa;
    padding: 10px 15px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  }

  .filters {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .filters label {
    margin: 0;
    font-weight: bold;
  }

  .filters input[type="datetime-local"] {
    padding: 5px 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 14px;
  }

  .filters button {
    background-color: #0d6efd;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s;
  }

  .filters button:hover {
    background-color: #0b5ed7;
  }

  .export-btn button {
    background-color: #3c7de5;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s;
  }

  .export-btn button:hover {
    background-color: #0f0779;
  }
</style>

<div class="container mt-5">
  <div class="filter-export-container">
    <!-- Date Filters -->
    <div class="filters">
      <label for="startDate">From:</label>
      <input type="datetime-local" id="startDate" />
      <label for="endDate">To:</label>
      <input type="datetime-local" id="endDate" />
      <button onclick="applyFilter()">
        <i class="fas fa-filter"></i> Filter
      </button>
    </div>

    <!-- Export Button -->
    <div class="export-btn">
      <button onclick="exportToExcel()">
        <i class="fas fa-file-excel"></i> Export to Excel
      </button>
    </div>
  </div>
  <table class="table table-bordered table-striped">
    <thead class="thead-dark">
      <tr>
        <th>Serial No</th>
        <th>Recipe Name</th>
        <th>Date/Time</th>
        <th>Filter Code</th>
        <th>RPM (Upper, Lower)<sub>RPM</sub></th>
        <th>Pressure (Upper, Lower)<sub>Pa</sub></th>
        <th>AirFlow (Upper, Lower)<sub>m³/h</sub></th>
        <th>Pressure (Max, Min)<sub>Pa</sub></th>
        <th>Average Motor<sub>RPM</sub></th>
        <th>Average Air Flow<sub>m³/h</sub></th>
        <th>Avg Pressure Diff<sub>Pa</sub></th>
        <th>User</th>
        <th>Test Time<sub>sec</sub></th>
        <th>Test Result (OK/NG)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="recipe-log-table">
      <!-- Data will be dynamically inserted here -->
    </tbody>
  </table>
  <!-- Pagination Controls -->
  <div class="d-flex justify-content-between align-items-center mt-4">
    <nav>
      <ul class="pagination mb-0" id="pagination">
        <!-- Dynamic pagination -->
      </ul>
    </nav>
  </div>
</div>
<!-- View Details Popup -->
<div id="detailsModal" class="modal-overlay">
  <div class="modal-content" id="modalContent">
    <div class="modal-header">
      <h3>Log Details</h3>
      <button class="close-btn" onclick="closeDetails()">✕</button>
    </div>

    <div id="detailsBody" class="details-grid"></div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let fullData = [];
let rowsPerPage = 10;
let currentPage = 1;

// Store filters globally so they don't reset
let filterStart = "";
let filterEnd = "";

// ----------------------------
// LOAD DATA WITH FILTER
// ----------------------------
function fetchRecipeLog() {

    console.log("Fetching logs with:", { filterStart, filterEnd });

    fetch(`/api/recipe_log?start_date=${filterStart}&end_date=${filterEnd}`)
        .then(res => res.json())
        .then(data => {
            fullData = data;
            currentPage = 1;
            renderPage(currentPage);
            setupPagination();
        })
        .catch(err => console.error("Fetch error:", err));
}

// ----------------------------
// APPLY FILTER
// ----------------------------
function applyFilter() {
    filterStart = document.getElementById("startDate").value;
    filterEnd = document.getElementById("endDate").value;

    fetchRecipeLog();
}

// ----------------------------
// RENDER TABLE
// ----------------------------
function renderPage(page) {

    document.getElementById("startDate").value = filterStart;
    document.getElementById("endDate").value = filterEnd;

    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    const visibleData = fullData.slice(start, end);
    const tableBody = document.getElementById("recipe-log-table");

    tableBody.innerHTML = "";

    visibleData.forEach(row => {

        let ngBadge = `<span class="status-badge neutral">N/A</span>`;
        if (row.NgStatus) {
            const s = row.NgStatus.toString().toLowerCase();
            ngBadge = s.includes("ok") ? 
                `<span class="status-badge ok">OK</span>` :
                s.includes("ng") ?
                `<span class="status-badge ng">NG</span>` :
                `<span class="status-badge neutral">${row.NgStatus}</span>`;
        }

        tableBody.innerHTML += `
            <tr>
                <td>${row.SerialNo}</td>
                <td>${row.Recipe_Name}</td>
                <td>${row.Timestamp}</td>
                <td>${row.Art_No}</td>
                
                <td>${row.Upper_fan_Speed}, ${row.Lower_fan_Speed}</td>
                <td>${row.Upper_Tolerance1}, ${row.Lower_Tolerance1}</td>
                <td>${row.Airflow_upper_limit}, ${row.Airflow_lower_limit}</td>
                <td>${row.Upper_Tolerance2}, ${row.Lower_Tolerance2}</td>
                
                <td>${row.Average_motor_RPM}</td>
                <td>${row.Avg_Air_Flow}</td>
                <td>${row.Average_Pressure}</td>

                <td>${row.user_Id || "Admin"}</td>
                <td>${row.testing_duration}</td>

                <td>${ngBadge}</td>

                <td>
                    <button class="view-btn" onclick='viewDetails(${JSON.stringify(row)})'>View</button>
                    <button class="print-btn" onclick="rePrint(${row.SerialNo})">Print</button>
                </td>
            </tr>
        `;
    });
}

// ----------------------------
// PAGINATION
// ----------------------------
function setupPagination() {

    const totalPages = Math.ceil(fullData.length / rowsPerPage);
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    const maxPages = 3;
    let start = Math.max(1, currentPage - Math.floor(maxPages / 2));
    let end = Math.min(start + maxPages - 1, totalPages);

    // previous
    pagination.innerHTML += `
        <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
        </li>
    `;

    // pages
    for (let i = start; i <= end; i++) {
        pagination.innerHTML += `
            <li class="page-item ${i === currentPage ? "active" : ""}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>`;
    }

    // next
    pagination.innerHTML += `
        <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
        </li>`;
}

function changePage(p) {
    const totalPages = Math.ceil(fullData.length / rowsPerPage);
    if (p < 1 || p > totalPages) return;
    currentPage = p;
    renderPage(p);
    setupPagination();
}

// ----------------------------
// REPRINT FIXED
// ----------------------------
function rePrint(serialNo) {

    console.log("▶ Reprint triggered:", serialNo);

    fetch(`/api/print_recipe/${serialNo}`, { method: "POST" })
        .then(r => r.json())
        .then(res => {
            if (res.success) alert("Print initiated");
            else alert("Failed to print");
        })
        .catch(err => console.error("Print error:", err));
}

// ----------------------------
// EXPORT FILTERED DATA ONLY
// ----------------------------
function exportToExcel() {
    let url = `/export_recipe_log?start_date=${encodeURIComponent(filterStart)}&end_date=${encodeURIComponent(filterEnd)}`;
    window.location.href = url;
}

// ----------------------------
// INITIAL LOAD
// ----------------------------
document.addEventListener("DOMContentLoaded", () => {

    const startInput = document.getElementById("startDate");
    const endInput = document.getElementById("endDate");

    const now = new Date();
    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);

    function fmt(d) {
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    startInput.value = fmt(yesterday);
    endInput.value = fmt(now);

    filterStart = startInput.value;
    filterEnd = endInput.value;

    fetchRecipeLog();
});
</script>



<!-- CSS -->
<style>
  nav {
    display: flex;
    justify-content: center;
    width: 100%;
  }

  .pagination {
    display: flex;
    flex-wrap: wrap;
    list-style: none;
    padding: 0;
    margin: 0;
    gap: 5px;
  }
  .pagination .page-item {
    margin: 0 2px;
  }

  .pagination .page-link {
    color: #007bff;
    padding: 6px 12px;
    text-decoration: none;
    border: 1px solid #dee2e6;
    border-radius: 4px;
  }
  .page-link {
    padding: 6px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    color: #007bff;
    background-color: #fff;
    cursor: pointer;
    transition: background-color 0.2s ease;
    text-align: center;
  }

  .page-item.active .page-link {
    background-color: #007bff;
    color: #fff;
    border-color: #007bff;
  }

  .page-item.disabled .page-link {
    color: #aaa;
    background-color: #f9f9f9;
    cursor: not-allowed;
  }

  .pagination .page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
  }

  .pagination .page-item.disabled .page-link {
    color: #fff;
    /* size: 12px; */
    pointer-events: none;
    background-color: #007bff;
  }

  .input-group {
    display: flex;
    align-items: center;
    margin-left: 1rem;
  }

  .input-group input {
    max-width: 100px;
    margin-right: 5px;
  }

  .d-flex {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 14px;
    align-items: center;
  }
  .print-btn {
    background-color: orange;
    color: white;
    border: none;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    border-radius: 5px;
  }
 .view-btn {
    background-color: rgb(118, 84, 240);
    color: white;
    border: none;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    border-radius: 5px;
  }
  .print-btn:hover {
    background-color: darkorange;
  }

  #recipe-log-table tr:nth-child(odd) {
    background-color: #f2f2f2; /* light grey */
  }
  #recipe-log-table tr:nth-child(even) {
    background-color: #e0e0e0; /* slightly darker grey */
  }

  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    color: white;
    text-align: center;
    min-width: 45px;
  }

  .status-badge.ok {
    background-color: #28a745; /* Green */
  }

  .status-badge.ng {
    background-color: #dc3545; /* Red */
  }

  .status-badge.neutral {
    background-color: #6c757d; /* Gray */
  }
  /* Modal overlay */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* Popup box */
.modal-content {
  background: white;
  width: 85%;
  max-height: 90vh;
  overflow-y: auto;
  border-radius: 10px;
  padding: 15px;
  position: relative;
  animation: popupFade 0.2s ease-in-out;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid #eee;
  padding-bottom: 8px;
}

.close-btn {
  background: red;
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
}

/* 4 columns */
.details-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  margin-top: 12px;
}

/* Each item */
.detail-item {
  background: #f7f7f7;
  border-left: 3px solid #007bff;
  padding: 6px;
  border-radius: 5px;
  font-size: 12px;  /* smaller */
  line-height: 13px;
}

@keyframes popupFade {
  from { opacity: 0; transform: scale(0.9); }
  to   { opacity: 1; transform: scale(1); }
}


</style>
<script>
window.onload = () => {
    loadPermissions("production");
};
function viewDetails(row) {
    const modal = document.getElementById("detailsModal");
    const body = document.getElementById("detailsBody");

    body.innerHTML = "";

    let index = 1;
    for (const [key, val] of Object.entries(row)) {
        body.innerHTML += `
            <div class="detail-item">
                <strong>${index}. ${formatKey(key)}</strong>: ${val ?? ""}
            </div>
        `;
        index++;
    }

    modal.style.display = "flex";
}

function formatKey(key) {
    return key.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
}

// Close button
function closeDetails() {
  document.getElementById("detailsModal").style.display = "none";
}

// Close on clicking outside
window.addEventListener("click", function(e) {
    const modal = document.getElementById("detailsModal");
    if (e.target === modal) {
        modal.style.display = "none";
    }
});


</script>
{% endblock %}
